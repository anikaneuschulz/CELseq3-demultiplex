How to demultiplex py CELseq barcodes:
--

**this works from the .fastq files generated by illumina bcltofastq**

Things you need:
- R1 and R2 in .fastq format (I1 is not needed)  
- a list of the CELseq barcodes used in your sample


setting up
--

1. create a working directory to demultiplex in
Check for sufficient space, as demultiplexing is a bit storage intense

1. paste the barcode sequences you used during library prep in a text file, each one on a separate line, place that file in the working directory. This is the **whitelist**  

1. get your R1 and R2 of the whole library and copy it to your working directory. Unzip both using 'gunzip <filename>' if needed (files ending in fastq.gz)

1. create 'pasted' versions of R1 and R2. (fastq format uses 4 lines for each read, so to work on a line-by-line basis we need to paste that information together in one line) ```cat {input} | paste -d '\t' - - - - | sort -k1,1 > {output}```

1. you can remove the original R1 and R2 from your working directory at this point

generate the index file
--

This file has information on which read name corresponds to which CELseq barcode, which demultiplexing is based upon.

1. get the readnames from the barcode read ```cut -f1 {BC_read} > {BC_read_readnames}```

1. get the barcodes. This assumes the barcode is in positions 7 to 14 of the barcode read ```cut -f2 {BC_read} | cut -c7-14 > {BC_read_barcodes}```

1. paste together the readnames and barcodes ```paste {BC_read_readnames} {BC_read_barcodes} > {BC_read_readnames_barcodes}```

1. remove the {BC_read_readnames} and {BC_read_barcodes} files to save space

**This is the index file completed**

set the script to work
--

issue the following command: ```python {demultiplexing script} {pasted_gene-read} {index_file} {whitelist}```

This is how it works:

1. gathering all raw barcodes and the reads associated with them
1. gathering all barcodes from the whitelist  
1. comparing the raw barcodes to the whitelist, barcodes with 1 mismatch to the whitelist are assumed to have a sequencing error and are corrected
1. prepare a final list of readnames assiciated with corrected barcodes  
1. open the pasted gene-reads file and use the readnames to demultiplex according to the final list
1. write the demultiplexed files. The 'pasting' is undone automatically, so the resulting reads are ready to be mapped with STAR. Filenames end in barcode sequences for distinguishing purposes.
